
/**
 * ç›Šç²¥å…¨è‡ªå‹•ç›®éŒ„ V4.6 - æ¥µç°¡è‹±æ–‡ ID ç‰ˆ
 * ç‰¹é»ï¼šæ”¹ç”¨ #bc-1, #bc-2 åºè™Ÿï¼Œè§£æ±ºä¸­æ–‡ç¶²å€è¤‡è£½å¾Œè®Šäº‚ç¢¼çš„å•é¡Œ
 */

// 1. ã€PHPã€‘ç‚º H2 åŠ ä¸Šæ¥µç°¡åºè™Ÿ ID
add_filter( 'the_content', 'bcongee_auto_header_ids_v4_6', 1 ); 
function bcongee_auto_header_ids_v4_6( $content ) {
    if ( ! is_singular( array( 'post', 'product' ) ) ) return $content;

    $count = 0;
    // åŒ¹é… h2 æ¨™ç±¤
    return preg_replace_callback( '/<(h2)([^>]*)>(.*?)<\/\1>/i', function( $matches ) use (&$count) {
        $tag = $matches[1];
        $attrs = $matches[2];
        $text = $matches[3];
        
        $count++;
        $id = 'bc-' . $count; // ç”¢ç”Ÿ bc-1, bc-2...
        
        // å¦‚æœåŸæœ¬å·²ç¶“æœ‰ id å±¬æ€§ï¼Œæˆ‘å€‘é‚„æ˜¯å¼·åˆ¶è¦†è“‹ç‚ºæ¥µç°¡ IDï¼Œç¢ºä¿åˆ†äº«æ™‚ä¸€è‡´
        $attrs = preg_replace('/id=["\'](.*?)["\']/', '', $attrs);
        
        return "<{$tag}{$attrs} id=\"{$id}\">{$text}</{$tag}>";
    }, $content );
}

// 2. ã€PHP + JSã€‘é å°¾ç”Ÿæˆç›®éŒ„
add_action( 'wp_footer', 'bcongee_toc_final_package_v4_6' );
function bcongee_toc_final_package_v4_6() {
    if ( ! is_singular( array( 'post', 'product' ) ) ) return;
    ?>
    <style>
        #bcongee-toc {
            background-color: #fffdf2;
            border: 2px solid #f9e8a5;
            border-radius: 12px;
            padding: 25px 30px;
            margin: 35px 0;
            box-shadow: 0 4px 15px rgba(220, 180, 50, 0.08);
        }
        #bcongee-toc .toc-title {
            font-size: 1.3rem;
            font-weight: 700;
            color: #8a6d3b;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            border-bottom: 1px solid #f1e0a1;
            padding-bottom: 12px;
        }
        #bcongee-toc .toc-title::before { content: "ğŸ“‹"; margin-right: 12px; }
        #bcongee-toc ul { list-style: none; padding: 0; margin: 0; }
        #bcongee-toc li { margin-bottom: 15px; line-height: 1.6; }
        #bcongee-toc a { 
            color: #5d4037; 
            text-decoration: none; 
            transition: all 0.3s ease; 
            display: inline-block;
            font-size: 1.1rem;
            font-weight: 500;
        }
        #bcongee-toc a:hover { color: #d35400; transform: translateX(8px); }
        @media (max-width: 768px) {
            #bcongee-toc { padding: 20px; }
            #bcongee-toc a { font-size: 1rem; }
        }
    </style>

    <script type="text/javascript">
    (function($) {
        $(document).ready(function() {
            // é¸å–æ‰€æœ‰æœ‰æ•ˆæ¨™é¡Œ
            var $headers = $('.entry-content').find('h2, .uagb-heading-text').filter(function() {
                var $this = $(this);
                var text = $this.text().trim();
                if ($this.closest('.wpbr-review, .wpbr-testimonial, .wp-business-reviews, .wpbr-item, .uagb-testimonial, .comments-area, #reviews').length > 0) return false;
                if ($this.prop("tagName") !== 'H2' && !$this.hasClass('uagb-heading-text')) return false;
                if (text.length <= 3 || text.length > 40 || text.includes("â˜…")) return false;
                return true;
            });

            if ($headers.length < 2) return;

            var tocHtml = '<div id="bcongee-toc"><span class="toc-title">æ–‡ç« é‡é»æ‘˜è¦ï¼š</span><ul>';
            $headers.each(function(index) {
                var $h = $(this);
                var text = $h.text().trim();
                var id = 'bc-' + (index + 1); // ç¢ºä¿ JS çš„ ID è·Ÿ PHP åŒæ­¥
                $h.attr('id', id);
                tocHtml += '<li class="toc-h2"><a href="#' + id + '">' + text + '</a></li>';
            });
            tocHtml += '</ul></div>';

            if ($headers.first().length > 0) {
                $(tocHtml).insertBefore($headers.first());
            }

            $(document).on('click', '#bcongee-toc a', function(e) {
                var hash = this.hash;
                if (hash && $(hash).length) {
                    e.preventDefault();
                    $('html, body').animate({
                        scrollTop: $(hash).offset().top - 140
                    }, 600);
                    history.pushState(null, null, hash);
                }
            });
        });
    })(jQuery);
    </script>
    <?php
}
